# 업무 히스토리 쓰레드 기능 기획서

**작성일**: 2025-11-18
**목적**: 업무별 변경사항을 쓰레드 형태로 시간순 기록 및 관리

---

## 1. 기능 개요

### 1.1 핵심 요구사항
- 각 업무(Task)에 대한 **변경사항을 쓰레드 형태**로 기록
- 히스토리 항목마다 **별도의 상태** 관리 (제작중, 컨펌중, 진행중, 완료 등)
- 업무 목록에서 **펼침/접기**로 히스토리 간단 확인
- 클릭 시 **상세 모달**에서 전체 히스토리 확인
- 업무 자체의 status(준비중/진행중/완료)와는 **독립적**으로 관리

### 1.2 사용자 시나리오

#### 시나리오 A: 관리자 (Admin)
1. 업무 목록에서 업무 #15 확인
2. 펼침 버튼 클릭 → 최근 3개 히스토리 요약 표시
3. "전체보기" 클릭 → 상세 모달 열림
4. 히스토리 추가: "홈페이지 메인 배너 디자인 1차 시안 완료"
5. 상태 선택: "컨펌중"
6. 저장 → 텔레그램/이메일 알림 (선택적)

#### 시나리오 B: 일반 사용자 (User)
1. 업무 목록에서 자신과 관련된 업무 확인
2. 펼침으로 진행 상황 간단 확인
3. 클릭하여 상세 히스토리 확인
4. 댓글로 피드백 작성

---

## 2. UI/UX 설계

### 2.1 업무 목록 화면 (확장형 리스트)

#### 기본 상태 (접힌 상태)
```
┌─────────────────────────────────────────────────────────────┐
│ [15] 2025-11-18   [기능개발] 업무 히스토리 기능 개발       │
│                   [진행중]  예상: 11-25  💬 3  [▼ 펼치기]   │
└─────────────────────────────────────────────────────────────┘
```

#### 확장 상태 (펼쳐진 상태)
```
┌─────────────────────────────────────────────────────────────┐
│ [15] 2025-11-18   [기능개발] 업무 히스토리 기능 개발       │
│                   [진행중]  예상: 11-25  💬 3  [▲ 접기]     │
├─────────────────────────────────────────────────────────────┤
│ 📋 최근 작업 이력 (3개)                       [전체보기 →] │
│                                                              │
│ ┌──────────────────────────────────────────────────────────┐│
│ │ 🟢 완료   2025-11-18 14:30   홍길동                     ││
│ │ UI 컴포넌트 1차 구현 완료                                ││
│ └──────────────────────────────────────────────────────────┘│
│                                                              │
│ ┌──────────────────────────────────────────────────────────┐│
│ │ 🔵 진행중  2025-11-18 10:00   김철수                    ││
│ │ API 엔드포인트 개발 착수                                 ││
│ └──────────────────────────────────────────────────────────┘│
│                                                              │
│ ┌──────────────────────────────────────────────────────────┐│
│ │ 🟡 컨펌중  2025-11-17 16:00   이영희                    ││
│ │ 데이터 모델 설계 검토 요청                               ││
│ └──────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────┘
```

### 2.2 상세 모달 화면

```
┌────────────────────────────────────────────────────────────────┐
│  [업무 상세] #15 업무 히스토리 기능 개발              [X 닫기] │
├────────────────────────────────────────────────────────────────┤
│  [탭] 업무정보 | 작업이력 | 댓글 | 첨부파일                    │
├────────────────────────────────────────────────────────────────┤
│                                                                 │
│  📝 작업 이력 (8개)                            [+ 새 이력 추가]│
│                                                                 │
│  ┌────────────────────────────────────────────────────────────┐│
│  │ 🟢 완료   2025-11-18 14:30   홍길동 (1시간 전)           ││
│  │                                                            ││
│  │ UI 컴포넌트 1차 구현 완료                                  ││
│  │                                                            ││
│  │ - HistoryItem 컴포넌트 작성                                ││
│  │ - 펼침/접기 애니메이션 구현                                ││
│  │ - 모바일 반응형 적용                                       ││
│  │                                                            ││
│  │ 📎 design_v1.png                           [수정] [삭제]   ││
│  └────────────────────────────────────────────────────────────┘│
│                                                                 │
│  ┌────────────────────────────────────────────────────────────┐│
│  │ 🔵 진행중  2025-11-18 10:00   김철수 (5시간 전)          ││
│  │                                                            ││
│  │ API 엔드포인트 개발 착수                                   ││
│  │                                                            ││
│  │ POST /api/tasks/:id/history 구현 중                        ││
│  │                                              [수정] [삭제]  ││
│  └────────────────────────────────────────────────────────────┘│
│                                                                 │
│  ┌────────────────────────────────────────────────────────────┐│
│  │ 🟡 컨펌중  2025-11-17 16:00   이영희 (어제)              ││
│  │                                                            ││
│  │ 데이터 모델 설계 검토 요청                                 ││
│  │                                                            ││
│  │ TaskHistory 스키마 초안 작성 완료, 검토 부탁드립니다       ││
│  │                                              [수정] [삭제]  ││
│  └────────────────────────────────────────────────────────────┘│
│                                                                 │
│  ... (더 보기)                                                  │
└────────────────────────────────────────────────────────────────┘
```

### 2.3 히스토리 추가 폼

```
┌────────────────────────────────────────────────────────────────┐
│  새 작업 이력 추가                                              │
├────────────────────────────────────────────────────────────────┤
│                                                                 │
│  상태 선택 *                                                    │
│  ┌──────────────────────────────────────────────────────────┐ │
│  │ [🔵 제작중 ▼]                                            │ │
│  └──────────────────────────────────────────────────────────┘ │
│                                                                 │
│  제목 *                                                         │
│  ┌──────────────────────────────────────────────────────────┐ │
│  │ UI 컴포넌트 1차 구현 완료                                │ │
│  └──────────────────────────────────────────────────────────┘ │
│                                                                 │
│  내용                                                           │
│  ┌──────────────────────────────────────────────────────────┐ │
│  │ - HistoryItem 컴포넌트 작성                              │ │
│  │ - 펼침/접기 애니메이션 구현                              │ │
│  │ - 모바일 반응형 적용                                     │ │
│  │                                                          │ │
│  └──────────────────────────────────────────────────────────┘ │
│                                                                 │
│  첨부파일                                                       │
│  ┌──────────────────────────────────────────────────────────┐ │
│  │ [📎 파일 선택]                                           │ │
│  └──────────────────────────────────────────────────────────┘ │
│                                                                 │
│                                       [취소]  [저장]            │
└────────────────────────────────────────────────────────────────┘
```

### 2.4 히스토리 상태 및 색상 체계

| 상태 | 아이콘 | 색상 | 의미 |
|------|--------|------|------|
| **제작중** | 🔵 | Blue | 작업 진행 중 |
| **컨펌중** | 🟡 | Yellow | 검토/승인 대기 |
| **진행중** | 🟠 | Orange | 활발히 진행 중 |
| **완료** | 🟢 | Green | 작업 완료 |
| **보류** | ⚪ | Gray | 일시 중단 |
| **취소** | 🔴 | Red | 작업 취소됨 |

---

## 3. 데이터 모델 설계

### 3.1 TaskHistory 스키마

```typescript
// types/index.ts
export interface TaskHistory {
  _id: string
  taskId: string // 연결된 업무 ID
  status: 'making' | 'confirming' | 'in_progress' | 'completed' | 'on_hold' | 'cancelled'
  title: string // 히스토리 제목 (필수)
  content?: string // 상세 내용 (선택)
  attachments?: Attachment[] // 첨부파일
  author: string // 작성자 ID (user._id)
  authorName: string // 작성자 이름 (스냅샷)
  createdAt: Date
  updatedAt: Date
}
```

### 3.2 MongoDB 스키마

```typescript
// lib/models/TaskHistory.ts
import mongoose, { Schema, Model } from 'mongoose'
import { TaskHistory } from '@/types'

const TaskHistorySchema = new Schema<TaskHistory>(
  {
    taskId: {
      type: String,
      required: true,
      index: true, // 빠른 조회를 위한 인덱스
    },
    status: {
      type: String,
      enum: ['making', 'confirming', 'in_progress', 'completed', 'on_hold', 'cancelled'],
      default: 'in_progress',
    },
    title: {
      type: String,
      required: true,
      trim: true,
    },
    content: {
      type: String,
      default: '',
    },
    attachments: [
      {
        filename: String,
        url: String,
        size: Number,
        mimeType: String,
        uploadedAt: {
          type: Date,
          default: Date.now,
        },
      },
    ],
    author: {
      type: String,
      required: true,
    },
    authorName: {
      type: String,
      required: true,
    },
  },
  {
    timestamps: true,
    collection: 'task_histories',
  }
)

// 인덱스: taskId + createdAt (시간순 조회 최적화)
TaskHistorySchema.index({ taskId: 1, createdAt: -1 })

const TaskHistoryModel: Model<TaskHistory> =
  mongoose.models.TaskHistory || mongoose.model<TaskHistory>('TaskHistory', TaskHistorySchema)

export default TaskHistoryModel
```

### 3.3 Task 타입 확장 (선택)

기존 Task 타입에 히스토리 개수를 추가할 수 있습니다 (선택적):

```typescript
// types/index.ts
export interface Task {
  // ... 기존 필드들
  historyCount?: number // 프론트엔드에서 표시용 (계산 필드)
}
```

---

## 4. API 설계

### 4.1 엔드포인트 목록

| Method | Endpoint | 설명 | 권한 |
|--------|----------|------|------|
| GET | `/api/tasks/:taskId/history` | 업무의 히스토리 목록 조회 | 인증 필요 |
| POST | `/api/tasks/:taskId/history` | 새 히스토리 추가 | Admin |
| GET | `/api/tasks/:taskId/history/:historyId` | 히스토리 상세 조회 | 인증 필요 |
| PATCH | `/api/tasks/:taskId/history/:historyId` | 히스토리 수정 | Admin + 작성자 |
| DELETE | `/api/tasks/:taskId/history/:historyId` | 히스토리 삭제 | Admin + 작성자 |

### 4.2 API 스펙 예시

#### GET `/api/tasks/:taskId/history`

**Query Parameters**:
- `limit` (선택): 조회 개수 (기본: 전체, 목록 펼침용은 3개)
- `offset` (선택): 페이지네이션

**Response**:
```json
{
  "histories": [
    {
      "_id": "674abcd123...",
      "taskId": "674abc123...",
      "status": "completed",
      "title": "UI 컴포넌트 1차 구현 완료",
      "content": "- HistoryItem 컴포넌트 작성\n- 펼침/접기 애니메이션 구현",
      "attachments": [
        {
          "filename": "design_v1.png",
          "url": "https://...",
          "size": 245678,
          "mimeType": "image/png",
          "uploadedAt": "2025-11-18T14:30:00Z"
        }
      ],
      "author": "user123",
      "authorName": "홍길동",
      "createdAt": "2025-11-18T14:30:00Z",
      "updatedAt": "2025-11-18T14:30:00Z"
    }
  ],
  "total": 8
}
```

#### POST `/api/tasks/:taskId/history`

**Request Body**:
```json
{
  "status": "completed",
  "title": "UI 컴포넌트 1차 구현 완료",
  "content": "- HistoryItem 컴포넌트 작성\n- 펼침/접기 애니메이션 구현",
  "attachments": [] // 파일 업로드는 별도 처리
}
```

**Response**:
```json
{
  "history": { /* 생성된 히스토리 객체 */ },
  "message": "작업 이력이 추가되었습니다"
}
```

---

## 5. 구현 단계

### Phase 1: 백엔드 기초 (1-2일)
- [ ] TaskHistory 타입 정의 (`types/index.ts`)
- [ ] TaskHistory MongoDB 스키마 작성 (`lib/models/TaskHistory.ts`)
- [ ] GET `/api/tasks/:taskId/history` API 구현
- [ ] POST `/api/tasks/:taskId/history` API 구현

### Phase 2: 프론트엔드 기초 (2-3일)
- [ ] `HistoryItem` 컴포넌트 작성
- [ ] `HistoryList` 컴포넌트 작성 (목록용)
- [ ] `HistoryForm` 컴포넌트 작성 (추가/수정)
- [ ] KanbanBoard에 펼침/접기 기능 추가

### Phase 3: 통합 및 상세 기능 (2-3일)
- [ ] 상세 모달에 히스토리 탭 추가
- [ ] PATCH, DELETE API 구현
- [ ] 파일 첨부 기능 구현
- [ ] 실시간 업데이트 (선택)

### Phase 4: 최적화 및 테스트 (1-2일)
- [ ] 페이지네이션 추가
- [ ] 로딩 상태 처리
- [ ] 에러 핸들링
- [ ] 모바일 반응형 최적화
- [ ] 접근성 개선

---

## 6. 기술적 고려사항

### 6.1 성능 최적화
- MongoDB 인덱스: `{ taskId: 1, createdAt: -1 }`
- 목록 펼침 시 최근 3개만 조회 (`limit=3`)
- 페이지네이션으로 대량 데이터 대응

### 6.2 사용자 경험
- 펼침/접기 애니메이션 (Framer Motion 또는 CSS Transition)
- 낙관적 업데이트 (히스토리 추가 시)
- 스켈레톤 로딩

### 6.3 보안
- 히스토리 수정/삭제: 작성자 본인 또는 Admin만
- 파일 업로드: MIME 타입 검증, 크기 제한
- XSS 방지: 사용자 입력 sanitization

### 6.4 확장성
- 알림 시스템 연동 (선택): 새 히스토리 추가 시 텔레그램/이메일
- 검색 기능: 히스토리 내용 전체 검색
- 필터링: 상태별, 작성자별 필터

---

## 7. 예상 질문 및 답변

### Q1: 업무 status와 히스토리 status의 차이는?
**A**:
- **업무 status**: 업무 전체의 진행 단계 (준비중 → 진행중 → 완료)
- **히스토리 status**: 개별 작업 항목의 상태 (제작중, 컨펌중, 진행중, 완료 등)
- 예: 업무가 "진행중"이어도, 히스토리 항목은 "컨펌중", "완료" 등 다양한 상태를 가질 수 있음

### Q2: 히스토리가 많아지면 성능 문제는?
**A**:
- 인덱스 최적화 (`taskId + createdAt`)
- 목록에서는 최근 3개만 표시
- 상세 모달에서 페이지네이션 적용
- 필요 시 가상 스크롤링 (react-window)

### Q3: 댓글과 히스토리의 차이는?
**A**:
- **댓글**: 짧은 의견/피드백 교환 (토론용)
- **히스토리**: 작업 진행 상황 기록 (로그용)
- 히스토리는 구조화되고 상태를 가지며, 댓글은 자유로운 대화

### Q4: 모바일에서는 어떻게 표시?
**A**:
- 펼침/접기 동일하게 동작
- 히스토리 항목은 카드 형태로 세로 배치
- 상태 아이콘과 제목 위주로 간결하게 표시

---

## 8. 다음 단계

이 기획서를 기반으로:

1. **데이터 모델 확정**: TaskHistory 스키마 검토 및 승인
2. **API 우선 구현**: 백엔드 API 먼저 개발 후 테스트
3. **UI 프로토타입**: Figma 또는 간단한 HTML 목업 작성 (선택)
4. **단계별 구현**: Phase 1 → 2 → 3 → 4 순차 진행

**예상 개발 기간**: 6-10일
**우선순위**: Phase 1 (백엔드) → Phase 2 (기본 UI) → Phase 3 (상세) → Phase 4 (최적화)

---

**문서 버전**: 1.0
**작성자**: Claude Code
**검토 필요**: 데이터 모델, API 스펙, 히스토리 상태 정의
